<?php

require_once "../connection.php";
require_once '../mail.php';

function test_input($data) {
  $data = trim($data);
  $data = stripslashes($data);
  $data = htmlspecialchars($data);
  return $data;
}

if(isset($_POST['submit'])) {
	try{
		//$db = new DB();

		$target_dir = "uploaded_file/";
		$target_binding_dir = "uploaded_binding_file/";	
		$target_file = $target_dir . basename($_FILES["fileToUpload"]["name"]);
		$uploadOk = 1;
		$status = 0;
		$fileStatus = 0;
		$bindingFileStatus = 0;
		$fileType = pathinfo($target_file,PATHINFO_EXTENSION);	
		
		// Check if file is a actual image or fake image
	/*	if(isset($_POST["submit"])) {
			$check = getimagesize($_FILES["fileToUpload"]["tmp_name"]);		
			if($check !== false) {
				echo "File is an image - " . $check["mime"] . ".";
				$uploadOk = 1;
			} else {
				echo "File is not an image.";
				$uploadOk = 0;
				$status = 1;
			} 		
		}
	*/	

		// Allow certain file formats	
		if($fileType != "pdf" && $fileType != "jpg") {
//			$statusMessage = "Sorry, only PDF & JPG files are allowed.";
			$statusMessage = "Greška, dozvoljene su samo PDF i JPG datoteke.";
			$uploadOk = 0;
			$fileStatus = 1;
		}
		// Check if $uploadOk is set to 0 by an error
		if ($uploadOk == 0) {
//			$statusMessage .= "Sorry, your file was not uploaded.";
			$statusMessage .= " Vaša datoteka nije otpremljena.";
		// if everything is ok, try to upload file
		} else {
			// Check if file already exists
			if (file_exists($target_file)) {
				unlink($target_file);
				move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file);
//				$statusMessage = "The file ". basename( $_FILES["fileToUpload"]["name"]). " has been uploaded.";
				$statusMessage = "Datoteka ". basename( $_FILES["fileToUpload"]["name"]). " je otpremljena.";
				$fileStatus = 2;			
			}
			else if (move_uploaded_file($_FILES["fileToUpload"]["tmp_name"], $target_file)) {
				//$uploadOk = $db->uploadFile($target_file);
				if($uploadOk == 1){
//					$statusMessage = "The file ". basename( $_FILES["fileToUpload"]["name"]). " has been uploaded.";
					$statusMessage = "Datoteka ". basename( $_FILES["fileToUpload"]["name"]). " je otpremljena.";
					$fileStatus = 3;
				} else {
//					$statusMessage = "Sorry, there was an error uploading your file to database.";
					$statusMessage = "Oprostite, došlo je do greške prilikom otpremanja Vaše datoteke u bazu podataka.";
					$fileStatus = 4;
				}
			} else {
//				$statusMessage = "Sorry, there was an error uploading your file to file system.";
				$statusMessage = "Oprostite, došlo je do greške prilikom otpremanja Vaše datoteke u sistem datoteka.";			
				$fileStatus = 5;
			}
		}
		if(!empty($_FILES['bindingFileToUpload']['name'])){		
			$target_binding_file = $target_binding_dir . basename($_FILES["bindingFileToUpload"]["name"]);	
			$bindingFileType = pathinfo($target_binding_file,PATHINFO_EXTENSION);
			
			// Allow certain file formats for binding
			if($bindingFileType != "pdf" && $bindingFileType != "jpg") {
//				$statusMessage = "Sorry, only PDF & JPG files are allowed.";			
				$statusMessage = "Greška, dozvoljene su samo PDF i JPG datoteke.";
				$uploadOk = 0;
				$bindingFileStatus = 1;
			}
			// Check if $uploadOk is set to 0 by an error
			if ($uploadOk == 0) {
//				$statusMessage = "Sorry, your file was not uploaded.";
				$statusMessage = "Oprostite, Vaša datoteka nije otpremljena.";
			// if everything is ok, try to upload file
			} else {
				// Check if file already exists
				if (file_exists($target_binding_file)) {
					unlink($target_binding_file);
					move_uploaded_file($_FILES["bindingFileToUpload"]["tmp_name"], $target_binding_file);
//					$statusMessage = "The file ". basename( $_FILES["bindingFileToUpload"]["name"]). " has been uploaded.";
					$statusMessage = "Datoteka ". basename( $_FILES["bindingFileToUpload"]["name"]). " je otpremljena.";
					$bindingFileStatus = 2;			
				}
				else if (move_uploaded_file($_FILES["bindingFileToUpload"]["tmp_name"], $target_binding_file)) {
					//$uploadOk = $db->uploadFile($target_file);
					if($uploadOk == 1){
//						$statusMessage = "The file ". basename( $_FILES["bindingFileToUpload"]["name"]). " has been uploaded.";
						$statusMessage = "Datoteka ". basename( $_FILES["bindingFileToUpload"]["name"]). " je otpremljena.";
						$bindingFileStatus = 3;
					} else {
//						$statusMessage = "Sorry, there was an error uploading your file to database.";
						$statusMessage = "Oprostite, došlo je do greške prilikom otpremanja datoteke u bazu podataka.";
						$bindingFileStatus = 4;
					}
				} else {
//					$statusMessage = "Sorry, there was an error uploading your file to file system.";			
					$statusMessage = "Oprostite, došlo je do greške prilikom otpremanja Vaše datoteke u sistem datoteka.";
					$bindingFileStatus = 5;
				}
			}
		}	
		
		$message = 
			'<html>
				<head><title> </title></head>
				<body>
					<label> Korisnik: </label> korisnik123 </br>
					<label> Datum: </label> '.date("d.m.Y.").' </br>
					<label> Vreme: </label> '.date("h:i").' </br>
					<label> Tip: </label> stampanje </br>
					<label> Datoteka: </label> '.basename( $_FILES["fileToUpload"]["name"]).' </br>
					<label> Izabrane opcije: </label> </br>
					<ul>
						<li>Broj primeraka: '.$_POST['noInput'].'</li>
						<li>Redosled stampanja: '.$_POST['orderOfInput'].'</li>
						<li>Boja: '.$_POST['colorOfInput'].'</li>
						<li>Nacin stampanja: '.$_POST['typeOfPrint'].'</li>
						<li>Velicina papira: '.$_POST['paperSize'].'</li>
						<li>Debljina papira: '.$_POST['paperWidth'].'</li>
						<li>Koricenje: '.$_POST['bindingType'].'</li>
						<li>Dodate korice: ';
				if(!empty($_FILES['bindingFileToUpload']['name'])){
					$message = $message . 'DA</li>
						<li>Naziv datoteke za korice: '. basename( $_FILES["bindingFileToUpload"]["name"]). '</li>';
				} else {
					$message = $message . 'NE</li>';
				}
				
				
		$message = $message . '
						<li>Heftanje: '.$_POST['heftingType'].'</li>
						<li>Busenje: '.$_POST['drillingType'].'</li>
						<li>Komentar korisnika: '. test_input($_POST['comment']).'</li>
					</ul>
				</body>
			</html>';
		
		
		if(!isset($_POST['sendCopy']))
			$mailStatus = sendMail($message);
		else {
			$mailStatus = sendMail($message, $_POST['userEmail']);		
		}
		
		$status = false;
		if(($fileStatus === 2 || $fileStatus === 3) && $mailStatus === true){
			if(!empty($_FILES['bindingFileToUpload']['name'])){
				if($bindingFileStatus === 2 || $bindingFileStatus === 3){
					$status = true;
				} else {
					$status = false;
				}
			} else {
				$status = true;
			}
		} else {
			$status = false;
		}		
	} catch(RuntimeException $e){
		return $e->getMessage();
	} 
}
?>

<!DOCTYPE html>
<html class="no-js" lang="sr">

<head>
  <meta charset="UTF-8">
  <title>ePrint</title>
  <!--Meta tags-->
  <meta name="description" content="Usluge se sastoje od pripreme za štampu, štampe, pečatiranja, kovertiranja, i otpremanja na poštu ili drugom dostavljaču.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,  shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!--Facebook meta tags-->
  <meta property="og:url" content="http://example .com/page.html">
  <meta property="og:title" content="ePrint">
  <meta property="og:image" content="http://example.com/image.jpg">
  <meta property="og:description" content="Usluge se sastoje od pripreme za štampu, štampe, pečatiranja, kovertiranja, i otpremanja na poštu ili drugom dostavljaču.">
  <meta property="og:site_name" content="Site Name">
  <meta property="og:locale" content="Sh_SP">
  <meta property="og:type" content="website" />
  <!-- Twitter meta tags -->
  <meta name="twitter:url" content="http://example.com/page.html">
  <meta name="twitter:title" content="ePrint">
  <meta name="twitter:image" content="http://example.com/image.jpg">
  <meta name="twitter:description" content=Usluge se sastoje od pripreme za štampu, štampe, pečatiranja, kovertiranja, i otpremanja na poštu ili drugom dostavljaču.>
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image:alt" content="Alt text for image">
  <!--Font from Google-->
  <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,600&amp;subset=latin-ext" rel="stylesheet" type="text/css">
  <!--CSS files-->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/style.css">
  <!--Favicon-->
  <!-- For IE 10 and below -->
  <!-- Place favicon.ico in the root directory - no tag necessary -->
  <!-- Icon in the highest resolution we need it for -->
  <link rel="icon" sizes="192x192" href="images/favicon.png">
  <!-- Apple Touch Icon (reuse 192px icon.png) -->
  <link rel="apple-touch-icon" href="images/favicon.png">
  <!-- Safari Pinned Tab Icon -->
  <link rel="mask-icon" href="images/favicon.png" color="blue">    
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="apple-touch-icon" href="images/icon.png">
  <!--FA icons-->
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- JS files -->
  <script src="js/main.js"></script>
</head>

<body>
  <div class="container container__main shadow">
    <!---- HEADER ---->
    <header>
      <div class="row">
        <div class="six columns">
          <a href="index.html">
            <img class="logo" src="images/eprint1.png" />
          </a>
        </div>
        <!---- NAVIGATION ---->
        <div class="six columns navigation__header navigation__header--nav">
            <!--Registruj se i Uloguj se-->
            <ul class="nav login nav-reg-log">
              <li>
                <button onclick="document.getElementById('modal1').style.display='block'">Uloguj se<i class="fas fa-user-plus" aria-hidden="true"></i></button>
              </li>
              <li>
                <button onclick="document.getElementById('modal2').style.display='block'">Registruj se<i class="fas fa-user-plus" aria-hidden="true"></i></button>
              </li>
            </ul>
        </div>
        <!--end of column-->
      </div>
      <!--end of row-->
    </header>

    <!-- LOGIN MODAL1 -->
  <div id="modal1" class="modal">
      <span onclick="document.getElementById('modal1').style.display='none'" class="close" title="Close Modal">&times;</span>
      <form class="modal-content animate" action="/action_page.php">
        <div class="container">
          <h1 class="log-reg__heading">Uloguj se</h1>
          <p>Popunite navedena polja.</p>
          <hr>
          <label for="email"><b>Email</b></label>
          <input type="text" placeholder="Unesite email" name="email" required>
    
          <label for="psw"><b>Lozinka</b></label>
          <input type="password" placeholder="Unesite lozinku" name="psw" required>
            
          <button type="submit" class="login-btn">Login</button>
          <label>
            <input type="checkbox" checked="checked" name="remember"> Zapamti me
          </label>
        </div>
    
        <div class="container" style="background-color:#f1f1f1; margin-top: 40px;">
          <div class="row">
            <div class="seven columns">
              <button type="button" onclick="document.getElementById('modal1').style.display='none'" class="cancelbtn">Nazad</button>
            </div>
            <div class="five columns" style="padding-top: 5px;">
                <a href="#">Zaboravili ste šifru?</a></span>
            </div>
          </div>
        </div>
      </form>
    </div>

        <!-- REGISTER MODAL 2 -->
        <div id="modal2" class="modal">
            <span onclick="document.getElementById('modal2').style.display='none'" class="close" title="Close Modal">&times;</span>
            <form class="modal-content animate" action="/action_page.php">
              <div class="container">
                <h1 class="log-reg__heading">Registruj se</h1>
                <p>Popunite navedena polja.</p>
                <hr>
                <label for="email"><b>Email</b></label>
                <input type="text" placeholder="Upisite Vasu email adresu" name="email" required>
          
                <label for="psw"><b>Lozinka</b></label>
                <input type="password" placeholder="Upisite Vasu lozinku" name="psw" required>
          
                <label for="psw-repeat"><b>Potvrdite lozinku</b></label>
                <input type="password" placeholder="Potvrdite Vasu lozinku" name="psw-repeat" required>
                
                <label>
                  <input type="checkbox" checked="checked" name="remember" style="margin-bottom:15px"> Zapamti me
                </label>
          
                <p>Pravljenjem naloga prihvatate nase <a href="#" style="color:dodgerblue">uslove</a> poslovanja</p>
          
                <div class="clearfix">
                  <button type="button" onclick="document.getElementById('modal2').style.display='none'" class="cancelbtn">Nazad</button>
                  <button type="submit" class="signupbtn">Registruj se</button>
                </div>
              </div>
            </form>
          </div>

    <!---- MAIN PAGE SECTION ---->
    <section class="section__main">
      <!--first row-->
      <div class="container">
        <div class="row">
          <!--Naslov Usluge-->
          <h2 class="mainpage__heading">Usluge</h2>
        </div>
      </div>
      <!--first three icons/h3-->
      <div class="container">
        <div class="row">
          <div class="one-third column">
            <i class="fas fa-print fa-2x"></i>
            <a href="./stampanje" class="link">
              <h3>Štampanje</h3>
            </a>
          </div>

          <div class="one-third column">
            <i class="far fa-clone fa-2x"></i>
            <a href="./blokovi" class="link">
              <h3>Preslikavajuci blokovi</h3>
            </a>
          </div>

          <div class="one-third column">
            <i class="far fa-file-alt fa-2x"></i>
            <a href="uplatnice/uplatnice.html" class="link">
              <h3>Uplatnice</h3>
            </a>
          </div>
          <!--end of last column-->
        </div>
      </div>
      <!--end of container-->

      <!--second three icons/h3-->
      <div class="container">
        <!--second row-->
        <div class="row">
          <div class="one-third column">
            <i class="far fa-envelope fa-2x"></i>
            <a href="./koverte-dostavnice-formulari" class="link">
              <h3>Koverte, Dostavnice, Formulari za adresiranje</h3>
            </a>
          </div>

          <div class="one-third column">
            <i class="fas fa-file-alt fa-2x"></i>
            <a href="./omot-spisa" class="link">
              <h3>Omot spisa</h3>
            </a>
          </div>
        </div>
        <!--end of row-->
      </div>
      <!--end of container-->
    </section>

    <!----SECTION OSTALO-->
    <section class="section__main section__ostalo">
      <div class="container">
        <h2 class="mainpage__heading">Ostalo</h2>
        <!--second row-->
        <div class="row">
          <div class="one-third column">
            <i class="far fa-money-bill-alt fa-2x"></i>
            <a href="./cenovnik" class="link">
              <h3>Cenovnik</h3>
            </a>
          </div>

          <div class="one-third column">
            <i class="fas fa-users fa-2x"></i>
            <a href="./o-nama" class="link">
              <h3>O nama</h3>
            </a>
          </div>

          <div class="one-third column">
            <i class="far fa-comment fa-2x"></i>
            <a href="./kontakt" class="link">
              <h3>Kontakt</h3>
            </a>
          </div>
        </div>
        <!--end of row-->
      </div>
      <!--end of container-->
    </section>


    <!--Footer-->
    <footer>
      <div class="container">
        <div class="row">
          <div class="one-half column">
            <p>26232 Pančevo, Matije Gupca 24</p>
          </div>
          <div class="one-half column">
            <p>065 983 983 8</p>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // Get the modal
    var modal = document.getElementById('modal1');
    var modal2 = document.getElementById('modal2');
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
        else if (event.target == modal2) {
          modal2.style.display = "none";
        }
    }

    </script> 
</body>

</html>
